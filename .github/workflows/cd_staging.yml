
 name: Deploy to staging

 on:
   push:
     branches:
       - production

 jobs:
   redeploy_everything:
     name: Deploying everything to staging cluster
     runs-on: ubuntu-latest

     steps:
       - name: SSH into server and deploy
         run: |
           echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key
           chmod 600 ssh_key

           ssh -o StrictHostKeyChecking=no -i ssh_key ubuntu@13.48.138.13 << 'EOF'
-            cd Valhalla-brush/ && git pull origin production
+            cd Valhalla-brush/
+            # ensure Git will perform a merge (default) rather than erroring
+            git config pull.rebase false
+            git pull origin production

             # install pnpm & pm2 so the commands exist
             sudo npm install -g pnpm pm2

             pnpm install
             pnpm run build

             pm2 restart http-backend
             pm2 restart ws-backend
             pm2 restart excelidraw-frontend
           EOF
